<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Child Health Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #376d8a 40%, #98edd9 75%, #d96382 90%);
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255, 182, 193, 0.15) 0%, transparent 60%),
        radial-gradient(circle at 80% 70%, rgba(173, 216, 230, 0.15) 0%, transparent 60%),
        radial-gradient(circle at 60% 20%, rgba(221, 160, 221, 0.15) 0%, transparent 60%),
        radial-gradient(circle at 40% 80%, rgba(255, 228, 196, 0.15) 0%, transparent 60%),
        radial-gradient(circle at 90% 40%, rgba(144, 238, 144, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 10% 90%, rgba(255, 192, 203, 0.1) 0%, transparent 50%);
      background-size: 400px 400px, 300px 300px, 500px 500px, 350px 350px, 250px 250px, 450px 450px;
      animation: textureMove 25s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes textureMove {
      0% { background-position: 0% 0%, 100% 100%, 50% 50%, 25% 75%, 75% 25%, 10% 90%; }
      50% { background-position: 20% 20%, 80% 80%, 70% 30%, 45% 55%, 95% 5%, 30% 70%; }
      100% { background-position: 0% 0%, 100% 100%, 50% 50%, 25% 75%, 75% 25%, 10% 90%; }
    }

    .navbar {
      background: linear-gradient(135deg, #D9EDF8 40%, #E4F1EE 50%, #F0D2DA 100%);
      color: #422779;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar .logo {
      font-size: 22px;
      font-weight: bold;
    }

    .navbar ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }

    .navbar ul li a {
      color: #422779;
      text-decoration: none;
      font-size: 16px;
    }

    .navbar .auth-buttons button {
      background-color: white;
      color: #422779;
      border: none;
      padding: 7px 15px;
      border-radius: 4px;
      margin-left: 10px;
      cursor: pointer;
    }

    .profile-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      margin-left: 15px;
    }

    .profile-icon {
      width: 40px;
      height: 40px;
      background-color: white;
      color: #422779;
      border-radius: 50%;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: default;
    }

    .menu-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
    }

    .menu-toggle span {
      height: 3px;
      width: 25px;
      background: #422779;
      margin: 4px 0;
    }

    @media (max-width: 768px) {
      .navbar ul {
        display: none;
        flex-direction: column;
        background: #ccb3ff;
        position: absolute;
        top: 60px;
        left: 0;
        width: 100%;
        padding: 10px 0;
      }

      .navbar ul.active {
        display: flex;
      }

      .menu-toggle {
        display: flex;
      }

      .auth-buttons {
        display: none;
      }
    }

    .container {
      width: 90%;
      margin: 20px auto;
    }

    h2.section-title {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #D9EDF8 40%, #E4F1EE 50%, #F0D2DA 100%);
      border-radius: 15px;
      color: #422779;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 5px 8px rgba(0,0,0,0.15);
      margin-bottom: 12px;
    }

    .card, table {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table, th, td {
      border: 1px solid #dda0dd;
    }

    th, td {
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    .id-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .id-photo {
      width: 100px;
      height: 100px;
      background: #ffffff;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #555;
    }

    .modules {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .module-card {
      background: #fff;
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .module-card:hover {
      transform: translateY(-5px);
    }

    .module-card h3 {
      margin-top: 10px;
      font-size: 18px;
      color: #422779;
    }

    .form-inline {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .form-inline input,
    .form-inline select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    .btn-small {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #422779;
      color: white;
      font-size: 13px;
      font-weight: 600;
      margin-top: 6px;
    }

    .status-text {
      font-size: 13px;
      margin-bottom: 6px;
      color: #555;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo">Child Health Dashboard</div>

    <div class="menu-toggle" onclick="toggleMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <ul id="nav-links">
      <li><a href="#">Home</a></li>
      <li><a href="#">Modules</a></li>
      <li><a href="#">Reports</a></li>
      <li><a href="#">Support</a></li>
    </ul>

    <div style="display: flex; align-items: center;">
      <div class="auth-buttons">
        <button id="logout-btn">Logout</button>
      </div>
      <div class="profile-wrapper" title="Current user">
        <div class="profile-icon" id="profile-icon">U</div>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="modules">
      <div class="module-card"><h3>Vaccination</h3></div>
      <div class="module-card"><h3>Appointments</h3></div>
      <div class="module-card"><h3>Medical History</h3></div>
      <div class="module-card"><h3>Diet & Nutrition</h3></div>
      <div class="module-card"><h3>ID Card</h3></div>
    </div>

    <!-- Virtual ID -->
    <div class="card">
      <h2 class="section-title">Virtual ID Card</h2>
      <div class="id-card">
        <div>
          <p><strong>Name:</strong> <span id="id-name">Loading...</span></p>
          <p><strong>Parent Email:</strong> <span id="id-parent-email">-</span></p>
        </div>
        <div class="id-photo">Photo</div>
      </div>
    </div>

    <!-- Vaccination -->
    <div class="card">
      <h2 class="section-title">Vaccination Record</h2>
      <p class="status-text" id="vaccination-status">Add vaccination details for this child.</p>

      <form id="vaccination-form">
        <div class="form-inline">
          <input type="text" id="vac-vaccine" placeholder="Vaccine name" required />
          <input type="date" id="vac-scheduled" />
          <input type="date" id="vac-given" />
          <select id="vac-status">
            <option value="Scheduled">Scheduled</option>
            <option value="Given">Given</option>
            <option value="Missed">Missed</option>
          </select>
        </div>
        <button type="submit" class="btn-small">Save Vaccination</button>
      </form>

      <br />
      <table>
        <thead>
          <tr>
            <th>Vaccine</th>
            <th>Scheduled Date</th>
            <th>Given Date</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="vaccinationBody">
          <tr><td colspan="4">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Appointments -->
    <div class="card">
      <h2 class="section-title">Appointments</h2>
      <p class="status-text" id="appointments-status">Add upcoming or past appointments.</p>

      <form id="appointments-form">
        <div class="form-inline">
          <input type="date" id="app-date" required />
          <input type="text" id="app-purpose" placeholder="Purpose" required />
          <input type="text" id="app-doctor" placeholder="Doctor" />
          <select id="app-status">
            <option value="Scheduled">Scheduled</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        <button type="submit" class="btn-small">Save Appointment</button>
      </form>

      <br />
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Purpose</th>
            <th>Doctor</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="appointmentsBody">
          <tr><td colspan="4">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://hfytpmyqvdzdehembdpr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmeXRwbXlxdmR6ZGVoZW1iZHByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTg3NzIsImV4cCI6MjA3NzkzNDc3Mn0.IBvAlibQX4ZpQeC1FMTPgPaD-2odx42Ec0CkilSGA4Y";

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    function toggleMenu() {
      const navLinks = document.getElementById("nav-links");
      navLinks.classList.toggle("active");
    }

    function setProfileIcon(user) {
      const profileIcon = document.getElementById("profile-icon");
      const email = user.email || "";
      const letter = email ? email.charAt(0).toUpperCase() : "U";
      profileIcon.textContent = letter;
    }

    async function getCurrentUser() {
      const { data, error } = await sb.auth.getUser();
      if (error || !data.user) {
        window.location.href = "index.html";
        return null;
      }
      return data.user;
    }

    async function loadUserProfile(user) {
      const nameEl = document.getElementById("id-name");
      const emailEl = document.getElementById("id-parent-email");

      nameEl.textContent = "Loading...";
      emailEl.textContent = user.email || "";

      const { data: row, error } = await sb
        .from("users")
        .select("*")
        .eq("id", user.id)
        .maybeSingle();

      if (error) {
        console.error("Error loading users row:", error);
        nameEl.textContent = user.user_metadata?.name || "(no name)";
        return;
      }

      if (!row) {
        nameEl.textContent = user.user_metadata?.name || "(no name)";
      } else {
        nameEl.textContent = row.name || "(no name)";
        emailEl.textContent = row.email || user.email || "";
      }
    }

    async function loadVaccinations(userId) {
      const tbody = document.getElementById("vaccinationBody");
      const statusEl = document.getElementById("vaccination-status");

      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

      const { data, error } = await sb
        .from("vaccinations")
        .select("vaccine, scheduled_date, given_date, status, user_id")
        .eq("user_id", userId)
        .order("scheduled_date", { ascending: true });

      if (error) {
        console.error("Vaccination fetch error:", error);
        tbody.innerHTML = '<tr><td colspan="4">Error loading data</td></tr>';
        statusEl.textContent = "Error loading vaccination records.";
        return;
      }

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No vaccination records yet. Please add above.</td></tr>';
        statusEl.textContent = "No vaccination records found yet.";
        return;
      }

      statusEl.textContent = "Showing vaccination records.";
      tbody.innerHTML = "";

      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.vaccine || "-"}</td>
          <td>${row.scheduled_date || "-"}</td>
          <td>${row.given_date || "-"}</td>
          <td>${row.status || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addVaccination(e) {
      e.preventDefault();

      const vaccine = document.getElementById("vac-vaccine").value.trim();
      const scheduled = document.getElementById("vac-scheduled").value || null;
      const given = document.getElementById("vac-given").value || null;
      const status = document.getElementById("vac-status").value;

      const { error } = await sb
        .from("vaccinations")
        .insert({
          // user_id is NOT sent; default auth.uid() will fill it
          vaccine: vaccine,
          scheduled_date: scheduled,
          given_date: given,
          status: status
        });

      if (error) {
        console.error("Error inserting vaccination:", error);
        alert("Error saving vaccination: " + (error.message || "check console"));
        return;
      }

      e.target.reset();
      document.getElementById("vac-status").value = "Scheduled";

      // reload using current user
      const user = await getCurrentUser();
      if (user) {
        await loadVaccinations(user.id);
      }
    }

    async function loadAppointments(userId) {
      const tbody = document.getElementById("appointmentsBody");
      const statusEl = document.getElementById("appointments-status");

      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

      const { data, error } = await sb
        .from("appointments")
        .select("date, purpose, doctor, status, user_id")
        .eq("user_id", userId)
        .order("date", { ascending: true });

      if (error) {
        console.error("Appointments fetch error:", error);
        tbody.innerHTML = '<tr><td colspan="4">Error loading data</td></tr>';
        statusEl.textContent = "Error loading appointments.";
        return;
      }

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No appointments yet. Please add above.</td></tr>';
        statusEl.textContent = "No appointments found yet.";
        return;
      }

      statusEl.textContent = "Showing appointments.";
      tbody.innerHTML = "";

      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.date || "-"}</td>
          <td>${row.purpose || "-"}</td>
          <td>${row.doctor || "-"}</td>
          <td>${row.status || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addAppointment(e) {
      e.preventDefault();

      const date = document.getElementById("app-date").value;
      const purpose = document.getElementById("app-purpose").value.trim();
      const doctor = document.getElementById("app-doctor").value.trim() || null;
      const status = document.getElementById("app-status").value;

      const { error } = await sb
        .from("appointments")
        .insert({
          // user_id is NOT sent; default auth.uid() will fill it
          date: date,
          purpose: purpose,
          doctor: doctor,
          status: status
        });

      if (error) {
        console.error("Error inserting appointment:", error);
        alert("Error saving appointment: " + (error.message || "check console"));
        return;
      }

      e.target.reset();
      document.getElementById("app-status").value = "Scheduled";

      const user = await getCurrentUser();
      if (user) {
        await loadAppointments(user.id);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const user = await getCurrentUser();
      if (!user) return;

      setProfileIcon(user);
      await loadUserProfile(user);

      const userId = user.id;

      // Attach form handlers (no userId param now)
      document
        .getElementById("vaccination-form")
        .addEventListener("submit", addVaccination);

      document
        .getElementById("appointments-form")
        .addEventListener("submit", addAppointment);

      // Logout
      document.getElementById("logout-btn").addEventListener("click", async () => {
        await sb.auth.signOut();
        window.location.href = "index.html";
      });

      // Load existing data
      await loadVaccinations(userId);
      await loadAppointments(userId);
    });
  </script>
</body>
</html>
